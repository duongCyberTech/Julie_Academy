generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

model User {
  uid       String        @id @default(uuid())
  username  String        @unique
  fname     String
  mname     String
  lname     String
  email     String        @unique
  password  String
  createAt  DateTime      @default(now())
  role      UserRole      @default(student)
  status    AccountStatus @default(inactive)
  avata_url String?
  comments  Comments[]
  follow    Follow[]
  parents   Parents?
  student   Student?
  thread    Thread[]
  tutor     Tutor?

  likes Likes[]
}

model Tutor {
  uid          String        @id @default(uuid())
  phone_number String?       @unique
  experiences  String?
  class        Class[]
  exams        Exams[]
  feedback     Feedback[]
  folder       Folders[]
  lesson_plan  Lesson_Plan[]
  questions    Questions[]
  resources    Resources[]
  user         User          @relation(fields: [uid], references: [uid])
}

model Parents {
  uid          String      @id @default(uuid())
  phone_number String?     @unique
  user         User        @relation(fields: [uid], references: [uid])
  family       is_family[]
}

model Student {
  uid        String       @id @default(uuid())
  school     String?
  dob        DateTime?
  badges     Claim[]
  exam_taken Exam_taken[]
  feedback   Feedback[]
  learning   Learning[]
  review     Review[]
  user       User         @relation(fields: [uid], references: [uid])
  family     is_family[]

  studentAnalytics Student_analytics[]
}

model is_family {
  student_uid String
  parents_uid String
  parents     Parents @relation(fields: [parents_uid], references: [uid])
  student     Student @relation(fields: [student_uid], references: [uid])

  @@id([student_uid, parents_uid])
}

model Feedback {
  feed_id     String   @id @default(uuid())
  content     String
  createdAt   DateTime @default(now())
  tutor_uid   String
  student_uid String
  student     Student  @relation(fields: [student_uid], references: [uid])
  tutor       Tutor    @relation(fields: [tutor_uid], references: [uid])
}

model Review {
  student_id String
  class_id   String
  createAt   DateTime @default(now())
  content    String
  rating     Decimal  @db.Decimal(3, 1)
  class      Class    @relation(fields: [class_id], references: [class_id])
  student    Student  @relation(fields: [student_id], references: [uid])

  @@id([student_id, class_id])
}

model Student_analytics {
  ana_id     String    @id @default(uuid())
  sum_exam_adaptive Int @default(0)
  max_score_practice Float @default(0.0)
  max_thread_comment Int @default(0)
  sum_exam   Int         @default(0)
  percentage_question_correct Float @default(0.0)
  incre_percentage_question_correct Float @default(0.0)
  streak     Int         @default(0)
  last_exam_taken_date  DateTime   @default(now())
  sign_up_date          DateTime   @default(now())
  student_id            String
  student               Student    @relation(fields: [student_id], references: [uid])
}

model Badge {
  badge_id      String  @id @default(uuid())
  title         String
  description   String
  badge_url     String?
  badge_type    BadgeType
  func_type     AggregateType
  value_type    ValueType
  threshold     Int
  badge_claimed Claim[]
}

model Claim {
  student_id String
  badge_id   String
  claim_at   DateTime @default(now())
  claim_level Int @default(0)
  badge      Badge   @relation(fields: [badge_id], references: [badge_id])
  student    Student @relation(fields: [student_id], references: [uid])

  @@id([student_id, badge_id])
}

model Class {
  class_id      String               @id @default(uuid())
  classname     String
  description   String
  createdAt     DateTime             @default(now())
  updateAt      DateTime             @default(now())
  duration_time Int
  nb_of_student Int
  status        ClassStatus          @default(pending)
  grade         Int
  subject       String
  tutor_uid     String
  startat       DateTime?            @default(now()) @db.Timestamp(6)
  plan_id       String?
  plan          Lesson_Plan?         @relation(fields: [plan_id], references: [plan_id])
  tutor         Tutor                @relation(fields: [tutor_uid], references: [uid])
  exam_open_in  Exam_open_in[]
  learning      Learning[]
  reviews       Review[]
  schedule      Schedule[]
  folders       Folder_of_class[]

  threads Thread[]
}

model Schedule {
  schedule_id  Int
  class_id     String
  startAt      String
  endAt        String
  link_meet    String
  meeting_date Decimal @db.Decimal
  class        Class   @relation(fields: [class_id], references: [class_id])

  @@id([schedule_id, class_id])
}

model Learning {
  class_id    String
  student_uid String
  class       Class   @relation(fields: [class_id], references: [class_id])
  student     Student @relation(fields: [student_uid], references: [uid])
  status      EnrollStatus  @default(pending)
  @@id([class_id, student_uid])
}

model Thread {
  thread_id          String               @id @default(uuid())
  title              String
  content            String
  createAt           DateTime             @default(now())
  updateAt           DateTime             @default(now())
  uid                String
  class_id           String
  class              Class                @relation(fields: [class_id], references: [class_id])
  comments           Comments[]
  followers          Follow[]
  Resource_of_Thread Resource_of_Thread[]
  sender             User                 @relation(fields: [uid], references: [uid])
  likes              Likes[]
}

model Comments {
  thread_id           String
  comment_id          Int
  content             String
  createAt            DateTime              @default(now())
  updateAt            DateTime              @default(now())
  uid                 String
  parent_cmt_id       Int? 
  parent_cmt          Comments?             @relation("CommentToParent", fields: [thread_id, parent_cmt_id], references: [thread_id, comment_id])
  thread              Thread                @relation(fields: [thread_id], references: [thread_id])
  sender              User                  @relation(fields: [uid], references: [uid])
  Resource_of_Comment Resource_of_Comment[]
  comments            Comments[]            @relation("CommentToParent")
  @@id([thread_id, comment_id])
  likes Likes[]
}

model Likes {
  react_id          String        @id @default(uuid())
  uid               String
  reactor           User          @relation(fields: [uid], references: [uid])
  thread_id         String
  comment_id        Int?
  thread            Thread?        @relation(fields: [thread_id], references: [thread_id])
  comment           Comments?      @relation(fields: [thread_id, comment_id], references: [thread_id, comment_id])
}

model Follow {
  thread_id String
  uid       String
  thread    Thread @relation(fields: [thread_id], references: [thread_id])
  follower  User   @relation(fields: [uid], references: [uid])

  @@id([thread_id, uid])
}

model Tag {
  uid       String  
  thread_id String
  comment_id Int
  tagAt     DateTime  @default(now())

  @@id([uid, thread_id, comment_id])
}

model Resources {
  did                  String                 @id @default(uuid())
  title                String
  description          String
  createAt             DateTime               @default(now())
  updateAt             DateTime               @default(now())
  file_type            String
  file_path            String
  version              Int
  num_pages            Int
  tutor_id             String
  Resource_of_Answer   Resource_of_Answer[]
  Resource_of_Comment  Resource_of_Comment[]
  Resource_of_Question Resource_of_Question[]
  Resource_of_Thread   Resource_of_Thread[]
  Resource_in_Folder   Resources_in_folder[]
  tutor                Tutor                  @relation(fields: [tutor_id], references: [uid])
}

model Folders {
  folder_id     String               @id @default(uuid())
  folder_name   String
  createdAt     DateTime             @default(now())
  updateAt      DateTime             @default(now())
  tutor_id      String
  parent_id     String?
  Folders       Folders?             @relation("FoldersToFolders", fields: [parent_id], references: [folder_id], onDelete: NoAction, onUpdate: NoAction, map: "Child_folder_fkey")
  other_Folders Folders[]            @relation("FoldersToFolders")
  class         Folder_of_class[] 
  resources     Resources_in_folder[]  
  tutor         Tutor                @relation(fields: [tutor_id], references: [uid])
}

model Categories {
  category_id      String       @id @default(uuid())
  category_name    String       
  description      String?
  createAt         DateTime     @default(now())
  updateAt         DateTime     @default(now())
  parent_id        String?
  Categories       Categories?  @relation("CategoriesToCategories", fields: [parent_id], references: [category_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_recursive_cate")
  other_Categories Categories[] @relation("CategoriesToCategories")
  questions        Questions[]
  structure        Structure[]
  class            Folder_of_class[]
  examTakens Exam_taken[]
}

model Resources_in_folder {
  resource_id     String
  resource        Resources     @relation(fields: [resource_id], references: [did])
  folder_id       String
  folder          Folders       @relation(fields: [folder_id], references: [folder_id])

  status          ResourceStatus  @default(show)
  @@id([resource_id, folder_id])
}

model Folder_of_class {
  category_id     String
  category        Categories    @relation(fields: [category_id], references: [category_id])
  class_id        String
  class           Class         @relation(fields: [class_id], references: [class_id])
  folder_id       String
  folder          Folders       @relation(fields: [folder_id], references: [folder_id])

  status          ResourceStatus  @default(show)
  @@id([category_id, class_id, folder_id])
}

model Structure {
  plan_id  String
  cate_id  String
  Category Categories  @relation(fields: [cate_id], references: [category_id])
  Plan     Lesson_Plan @relation(fields: [plan_id], references: [plan_id])

  @@id([plan_id, cate_id])
}

model Questions {
  ques_id              String                 @id @default(uuid())
  content              String
  explaination         String?
  type                 QuestionType           @default(single_choice)
  level                DifficultyLevel        @default(easy)
  createAt             DateTime               @default(now())
  updateAt             DateTime               @default(now())
  category_id          String?
  tutor_id             String
  status               QuestionStatus         @default(draft)
  accessMode           QuestionAccess         @default(private)
  title                String
  answers              Answers[]
  exam_takens          Question_for_exam_taken[]
  exam_questions       Question_of_exam[]
  category             Categories?            @relation(fields: [category_id], references: [category_id])
  tutor                Tutor                  @relation(fields: [tutor_id], references: [uid])
  Resource_of_Question Resource_of_Question[]
}

model Answers {
  ques_id            String
  aid                Int
  content            String
  is_correct         Boolean              @default(false)
  explaination       String?
  question           Questions            @relation(fields: [ques_id], references: [ques_id])
  Resource_of_Answer Resource_of_Answer[]

  @@id([ques_id, aid])
}

model Exams {
  exam_id        String             @id @default(uuid())
  title          String
  description    String?
  level          DifficultyLevel    @default(easy)
  duration       Int
  total_score    Int
  total_ques     Int
  createdAt      DateTime           @default(now())
  updateAt       DateTime           @default(now())
  tutor_id       String
  sessions       Exam_session[]
  tutor          Tutor              @relation(fields: [tutor_id], references: [uid])
  exam_questions Question_of_exam[]
}

model Question_of_exam {
  exam_id  String
  ques_id  String
  score    Decimal   @default(0.00) @db.Decimal(4, 2)
  exam     Exams     @relation(fields: [exam_id], references: [exam_id])
  question Questions @relation(fields: [ques_id], references: [ques_id])

  @@id([exam_id, ques_id])
}

model Exam_session {
  exam_id            String
  session_id         Int
  startAt            DateTime       @default(now())
  expireAt           DateTime
  exam_type          ExamType       @default(practice)
  limit_taken        Int            @default(1)
  total_student_done Int            @default(0)
  exam_open_in       Exam_open_in[]
  exam               Exams          @relation(fields: [exam_id], references: [exam_id])

  @@id([exam_id, session_id])
  examTakens Exam_taken[]
  @@unique([session_id, exam_id])
}

model Exam_open_in {
  session_id   Int
  exam_id      String
  class_id     String
  ratio        Int?
  class        Class        @relation(fields: [class_id], references: [class_id])
  exam_session Exam_session @relation(fields: [session_id, exam_id], references: [session_id, exam_id])

  @@id([session_id, exam_id, class_id])
}

model Exam_taken {
  et_id                String            @id @default(uuid())
  final_score          Int
  total_ques_completed Int
  startAt              DateTime          @default(now())
  doneAt               DateTime          @default(now())
  isDone               Boolean           @default(false)
  exam_id              String?
  session_id           Int?
  student_uid          String
  category_id          String?
  category             Categories?       @relation(fields: [category_id], references: [category_id])
  exam_session         Exam_session?     @relation(fields: [exam_id, session_id], references: [exam_id, session_id])
  questions            Question_for_exam_taken[]
  student              Student           @relation(fields: [student_uid], references: [uid])
}

model Question_for_exam_taken {
  ques_id               String 
  et_id                 String 
  index                 Int 
  isDone                Boolean    @default(false)
  chosen_answer_at      DateTime?
  answer_set            Json      @db.JsonB
  exam_taken Exam_taken @relation(fields: [et_id], references: [et_id])
  question   Questions  @relation(fields: [ques_id], references: [ques_id])

  @@id([et_id, ques_id])     
}

model Lesson_Plan {
  plan_id     String      @id @default(uuid()) @db.VarChar(255)
  title       String      @unique @db.VarChar(255)
  subject     String      @db.VarChar(20)
  grade       Int         @db.SmallInt
  description String?
  type        PlanType    @default(custom)
  tutor_id    String?
  classes     Class[]
  tutor       Tutor?      @relation(fields: [tutor_id], references: [uid])
  structure   Structure[]
}

model Resource_of_Answer {
  did       String    @db.VarChar(255)
  aid       Int       @db.SmallInt
  ques_id   String    @db.VarChar(255)
  Resources Resources @relation(fields: [did], references: [did], onDelete: NoAction, onUpdate: NoAction)
  Answers   Answers   @relation(fields: [ques_id, aid], references: [ques_id, aid], onDelete: NoAction, onUpdate: NoAction)

  @@id([did, aid, ques_id])
}

model Resource_of_Comment {
  thread_id  String    @db.VarChar(255)
  comment_id Int       
  did        String    @db.VarChar(255)
  Resources  Resources @relation(fields: [did], references: [did], onDelete: NoAction, onUpdate: NoAction)
  Comments   Comments  @relation(fields: [thread_id, comment_id], references: [thread_id, comment_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([did, comment_id, thread_id])
}

model Resource_of_Question {
  did       String    @db.VarChar(255)
  ques_id   String    @db.VarChar(255)
  Resources Resources @relation(fields: [did], references: [did], onDelete: NoAction, onUpdate: NoAction)
  Questions Questions @relation(fields: [ques_id], references: [ques_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([did, ques_id])
}

model Resource_of_Thread {
  thread_id String    @db.VarChar(255)
  did       String    @db.VarChar(255)
  Resources Resources @relation(fields: [did], references: [did], onDelete: NoAction, onUpdate: NoAction)
  Thread    Thread    @relation(fields: [thread_id], references: [thread_id], onDelete: NoAction, onUpdate: NoAction)

  @@id([did, thread_id])
}

enum UserRole {
  admin
  tutor
  student
  parents
}

enum AccountStatus {
  active
  inactive
}

enum ClassStatus {
  pending
  ongoing
  completed
  cancelled
}

enum QuestionType {
  single_choice
  multiple_choice
  true_false
  short_answer
  essay
}

enum DifficultyLevel {
  easy
  medium
  hard
}

enum QuestionStatus {
  draft
  ready
}

enum QuestionAccess {
  private
  public
}

enum ExamType {
  practice
  test
  final
}

enum PlanType {
  book
  custom
}

enum ResourceStatus {
  show 
  hidden
}

enum EnrollStatus {
  pending 
  accepted
  cancelled
  completed
}

enum BadgeType {
  exam
  exam_practice
  exam_adaptive
  exam_test
  thread
  thread_comment 
  question_correct
  score
  score_test
  score_practice
  streak
}

enum AggregateType {
  sum
  avg
  max 
  incre
}

enum ValueType {
  value 
  percent
}